function sortByRoute (a,b) {
    'use strict';

    return a.route > b.route;
}

module.exports = function (app, config) {
    'use strict';

    var resources, method, route, slices, resource, file, downloadUrl;

    resources   = {};
    config      = config || {};
    downloadUrl = config.downloadUrl || '/resources.js';

    for (method in app.routes) {
        if (app.routes.hasOwnProperty(method)) {
            for (route = 0; route < app.routes[method].length; route = route + 1) {
                slices = app.routes[method][route].path.split('/');
                if (slices[slices.length - 1].substring(0,1) !== ':') {
                    resource = slices[slices.length - 1];
                } else {
                    resource = slices[slices.length - 2];
                }
                if (!resources[resource]) {
                    resources[resource] = [];
                }
                resources[resource].push({'method' : method, 'route' : app.routes[method][route].path});
            }
        }
    }

    file = 'angular.module(\'resources\', [\'ngResource\'])';
    for (resource in resources) {
        if (resources.hasOwnProperty(resource)) {
            route = resources[resource].sort(sortByRoute).pop().route;
            file += '.factory(\'' + resource + '\', function ($resource) { return $resource(\'' + route + '\', {}) })';
        }
    }
    file += ';';

    app.get(downloadUrl, function (request, response) {
        response.set('Content-Type', 'text/javascript');
        response.send(file);
    });
};
